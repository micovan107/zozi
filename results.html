<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>K·∫øt qu·∫£ t√¨m ki·∫øm</title>
<link rel="stylesheet" href="style.css" />
<style>
  .load-more-container { text-align: center; margin: 20px 0; }
  .load-more-btn {
    background: #1a73e8; color: white; padding: 10px 20px;
    border: none; border-radius: 6px; cursor: pointer; font-size: 15px;
  }
  .load-more-btn:hover { background: #0f5bb5; }
  .no-result { margin: 40px; font-size: 18px; color: #777; text-align: center; }
</style>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body class="srp">
  <header class="search-header">
    <form id="searchForm" class="header-search-bar">
      <div class="header-logo" onclick="window.location='index.html'">T√¨m Ki·∫øm</div>
      <input type="text" id="searchBox" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
      <button type="submit">üîç</button>
    </form>
    <nav class="tabs">
      <button class="tab active" data-type="all">T·∫•t c·∫£</button>
      <button class="tab" data-type="image">H√¨nh ·∫£nh</button>
      <button class="tab" data-type="video">Video</button>
    </nav>
  </header>

  <div class="results-container" id="resultsContainer"></div>
  <div class="load-more-container" id="loadMoreContainer" style="display:none;">
    <button class="load-more-btn" id="loadMoreBtn">Th√™m k·∫øt qu·∫£</button>
  </div>

  <script>
    let params = new URLSearchParams(window.location.search);
    let query = params.get('q') || '';
    document.getElementById('searchBox').value = query;

    const tabs = document.querySelectorAll('.tab');
    let currentType = params.get('type') || 'all';
    let allResults = [];
    let visibleCount = 20;
    const cache = {};

    // --- Ch·ªçn tab ---
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentType = tab.getAttribute('data-type');
        visibleCount = 20;
        updateUrl();  // C·∫≠p nh·∫≠t URL khi ƒë·ªïi tab
        loadResults();
      });
    });

    // --- Kh√¥ng reload khi t√¨m ---
    document.getElementById('searchForm').addEventListener('submit', async e => {
      e.preventDefault();
      const q = document.getElementById('searchBox').value.trim();
      if (!q) return;
      query = q;
      visibleCount = 20;
      updateUrl();
      await loadResults();
    });

    // --- C·∫≠p nh·∫≠t URL m√† kh√¥ng reload ---
    function updateUrl() {
      const newUrl = `?q=${encodeURIComponent(query)}&type=${currentType}`;
      history.replaceState({}, '', newUrl);
      params = new URLSearchParams(newUrl);
    }

    async function fuzzySearch(query, data) {
      const fuse = new Fuse(data, {
        keys: ["title", "desc", "domain"],
        threshold: 0.4,
        ignoreLocation: true,
        minMatchCharLength: 2,
      });
      return fuse.search(query).map(r => r.item);
    }

    async function getData(file) {
      if (cache[file]) return cache[file];
      const res = await fetch(file);
      const data = await res.json();
      cache[file] = data;
      return data;
    }

    async function loadResults() {
      const fileMap = {
        all: 'data.json',
        image: 'image.json',
        video: 'video.json'
      };

      try {
        const data = await getData(fileMap[currentType]);
        const keyword = query.toLowerCase().trim();
        if (!keyword) return;

        const safeKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b${safeKeyword}\\b`, 'i');
        const regexStart = new RegExp(`^${safeKeyword}\\b`, 'i');
        const regexExact = new RegExp(`^${safeKeyword}$`, 'i');

        let filtered = data.map(item => {
          const title = (item.title || '').toLowerCase();
          const desc = (item.desc || '').toLowerCase();
          const domain = (item.domain || '').toLowerCase();
          let score = 0;
          if (regexExact.test(title)) score += 100;
          else if (regexStart.test(title)) score += 60;
          else if (regex.test(title)) score += 30;
          if (regex.test(desc)) score += 10;
          if (regex.test(domain)) score += 5;
          return { ...item, score };
        }).filter(i => i.score > 0);

        if (filtered.length < 5 && query.length > 1) {
          filtered = await fuzzySearch(query, data);
        } else {
          filtered.sort((a, b) => b.score - a.score);
        }

        allResults = filtered;
        renderResults();
      } catch (err) {
        console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err);
      }
    }

    function renderResults() {
      const container = document.getElementById('resultsContainer');
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      const resultsToShow = allResults.slice(0, visibleCount);

      if (allResults.length === 0) {
        container.innerHTML = `<div class="no-result">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o cho ‚Äú<b>${query}</b>‚Äù</div>`;
        loadMoreContainer.style.display = 'none';
        return;
      }

      if (currentType === 'all') {
        container.innerHTML = resultsToShow.map(item => `
          <div class="result-item">
            <div class="result-link">
              <img src="${item.favicon || ''}" alt="">
              <span>${item.domain || ''}</span>
            </div>
            <a href="${item.link}" class="result-title" target="_blank">${item.title}</a>
            <p class="result-desc">${item.desc || ''}</p>
          </div>
        `).join('');
      } else if (currentType === 'image') {
        container.innerHTML = `
          <div class="image-grid">
            ${resultsToShow.map(item => `
              <div class="image-item">
                <a href="${item.link}" target="_blank">
                  <img src="${item.link}" alt="${item.title}">
                </a>
                <div class="image-info">
                  <img src="${item.favicon}" alt="">
                  <span>${item.domain}</span>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else if (currentType === 'video') {
        container.innerHTML = resultsToShow.map(item => `
          <div class="video-item">
            <a href="${item.link}" target="_blank">
              <div class="video-thumb">
                <img src="https://img.youtube.com/vi/${extractYoutubeId(item.link)}/0.jpg" alt="${item.title}">
              </div>
              <div class="video-info">
                <div class="result-title">${item.title}</div>
                <div class="result-desc">${item.desc || ''}</div>
                <div class="result-link">
                  <img src="${item.favicon}" alt="">
                  <span>${item.domain}</span>
                </div>
              </div>
            </a>
          </div>
        `).join('');
      }

      loadMoreContainer.style.display = visibleCount < allResults.length ? 'block' : 'none';
    }

    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      visibleCount += 20;
      renderResults();
    });

    function extractYoutubeId(url) {
      const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      return match ? match[1] : 'dQw4w9WgXcQ';
    }

    loadResults();
  </script>
</body>
</html>

